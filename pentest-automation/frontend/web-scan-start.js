// Web Scan Start Button Handler
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('web-scan-start');

    if (startButton) {
        startButton.addEventListener('click', async () => {
            // Get form values
            const targetUrl = document.getElementById('web-target-url')?.value.trim();
            const gobusterEnabled = document.getElementById('gobuster-enabled')?.checked || false;
            const niktoEnabled = document.getElementById('nikto-enabled')?.checked || false;
            const recursiveEnabled = document.getElementById('recursive-scan')?.checked || false;
            const sslEnforce = document.getElementById('ssl-enforce')?.checked || false;

            // Validation
            if (!targetUrl) {
                alert('Hedef URL girmeniz gereklidir!');
                return;
            }

            if (!gobusterEnabled && !niktoEnabled) {
                alert('En az bir tarama türü seçmelisiniz (Gobuster veya Nikto)!');
                return;
            }

            // Wordlist validation for Gobuster
            const wordlist = document.getElementById('wordlist-manual')?.value.trim();
            if (gobusterEnabled && !wordlist) {
                alert('Gobuster için wordlist girmeniz gereklidir!');
                return;
            }

            // Get recursive mode (only if recursive enabled)
            let recursiveMode = 'base';
            if (recursiveEnabled) {
                const selectedMode = document.querySelector('input[name="recursive-mode"]:checked');
                recursiveMode = selectedMode?.value || 'base';
            }

            // Build request payload
            const payload = {
                target_url: targetUrl,
                gobuster: {
                    enabled: gobusterEnabled,
                    threads: document.getElementById('gobuster-threads')?.value || '10',
                    delay: document.getElementById('gobuster-delay')?.value || '0'
                },
                nikto: {
                    enabled: niktoEnabled,
                    scan_type: document.getElementById('nikto-scan-type')?.value || '',
                    delay: document.getElementById('nikto-delay')?.value || '0'
                },
                ssl_enforce: sslEnforce,
                recursive: recursiveEnabled,
                recursive_mode: recursiveMode,
                wordlist: wordlist
            };

            console.log('[DEBUG] Web scan payload:', payload);

            // Disable button
            startButton.disabled = true;
            startButton.textContent = 'Tarama Başlatılıyor...';

            try {
                // Start scan
                const response = await fetch('/api/webscan/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    console.log('[INFO] Web scan started:', data.scan_id);

                    // Start polling for results
                    pollWebScanStatus(data.scan_id);
                } else {
                    throw new Error(data.error || 'Tarama başlatılamadı');
                }
            } catch (error) {
                console.error('[ERROR] Web scan start failed:', error);
                alert(`Hata: ${error.message}`);

                // Re-enable button on error
                startButton.disabled = false;
                startButton.textContent = 'Taramayı Başlat';
            }
        });
    }
});

// Poll web scan status
let webScanPollInterval = null;

function pollWebScanStatus(scanId) {
    webScanPollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/webscan/status/${scanId}`);
            const data = await response.json();

            if (!data.success) {
                clearInterval(webScanPollInterval);
                alert(`Tarama hatası: ${data.error}`);
                resetWebScanButton();
                return;
            }

            // Update Gobuster results
            if (data.gobuster && data.gobuster.enabled) {
                updateGobusterResults(data.gobuster.results);
            }

            // Update Nikto output (show section only if enabled)
            const niktoSection = document.getElementById('nikto-analysis');
            if (data.nikto && data.nikto.enabled) {
                if (niktoSection) niktoSection.style.display = 'block';
                updateNiktoOutput(data.nikto.output);
            } else {
                if (niktoSection) niktoSection.style.display = 'none';
            }

            // Check if scan is completed
            if (data.status === 'completed' || data.status === 'error' || data.status === 'cancelled') {
                clearInterval(webScanPollInterval);
                resetWebScanButton();

                if (data.status === 'error') {
                    alert('Tarama sırasında hata oluştu');
                }
            }

        } catch (error) {
            console.error('[ERROR] Polling failed:', error);
            clearInterval(webScanPollInterval);
            resetWebScanButton();
        }
    }, 1000); // Poll every 1 second
}

function resetWebScanButton() {
    const startButton = document.getElementById('web-scan-start');
    if (startButton) {
        startButton.disabled = false;
        startButton.textContent = 'Taramayı Başlat';
    }
}

// Update Gobuster results in table
function updateGobusterResults(results) {
    const webTableBody = document.getElementById('web-table-body');

    if (!results || results.length === 0) {
        webTableBody.innerHTML = '<div style="color: #888D9D; padding: 20px; text-align: center;">Henüz sonuç bulunamadı...</div>';
        return;
    }

    webTableBody.innerHTML = '';

    results.forEach(result => {
        const row = document.createElement('div');
        row.className = 'table-row';

        row.innerHTML = `
            <div class="table-cell path">${result.path}</div>
            <div class="table-cell status status-${result.status}">${result.status}</div>
            <div class="table-cell">${result.size}</div>
            <div class="table-cell">${result.type}</div>
        `;

        webTableBody.appendChild(row);
    });
}

// Update Nikto output in terminal
function updateNiktoOutput(outputLines) {
    const niktoTerminal = document.getElementById('nikto-terminal');

    // Don't update if Nikto terminal doesn't exist
    if (!niktoTerminal) return;

    if (!outputLines || outputLines.length === 0) {
        // Show placeholder only if we're actively scanning
        niktoTerminal.innerHTML = '<div style="color: #888D9D; font-style: italic;">Tarama devam ediyor...</div>';
        return;
    }

    niktoTerminal.innerHTML = '';

    outputLines.forEach(line => {
        const lineDiv = document.createElement('div');
        lineDiv.className = `nikto-line nikto-${line.type}`;
        lineDiv.textContent = line.message;
        niktoTerminal.appendChild(lineDiv);
    });
}
