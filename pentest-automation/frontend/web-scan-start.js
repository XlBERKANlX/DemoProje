// Web Scan Start Button Handler
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('btn-start-webscan');

    if (startButton) {
        startButton.addEventListener('click', async () => {
            // Get form values
            const targetUrl = document.getElementById('web-target-url')?.value.trim();
            const gobusterEnabled = document.getElementById('gobuster-enabled')?.checked || false;
            const niktoEnabled = document.getElementById('nikto-enabled')?.checked || false;
            const recursiveEnabled = document.getElementById('recursive-scan')?.checked || false;
            const sslEnforce = document.getElementById('ssl-enforce')?.checked || false;

            // Validation
            if (!targetUrl) {
                alert('Hedef URL girmeniz gereklidir!');
                return;
            }

            if (!gobusterEnabled && !niktoEnabled) {
                alert('En az bir tarama türü seçmelisiniz (Gobuster veya Nikto)!');
                return;
            }

            // Wordlist validation for Gobuster
            const wordlist = document.getElementById('wordlist-manual')?.value.trim();
            if (gobusterEnabled && !wordlist) {
                alert('Gobuster için wordlist girmeniz gereklidir!');
                return;
            }

            // Get recursive mode (only if recursive enabled)
            let recursiveMode = 'base';
            if (recursiveEnabled) {
                const selectedMode = document.querySelector('input[name="recursive-mode"]:checked');
                recursiveMode = selectedMode?.value || 'base';
            }

            // Build request payload
            const payload = {
                target_url: targetUrl,
                gobuster: {
                    enabled: gobusterEnabled,
                    threads: document.getElementById('gobuster-threads')?.value || '10',
                    delay: document.getElementById('gobuster-delay')?.value || '0'
                },
                nikto: {
                    enabled: niktoEnabled,
                    scan_type: document.getElementById('nikto-scan-type')?.value || '',
                    delay: document.getElementById('nikto-delay')?.value || '0'
                },
                ssl_enforce: sslEnforce,
                recursive: recursiveEnabled,
                recursive_mode: recursiveMode,
                wordlist: wordlist
            };

            console.log('[DEBUG] Web scan payload:', payload);

            // Disable button
            startButton.disabled = true;
            startButton.textContent = 'Tarama Başlatılıyor...';

            try {
                // Start scan
                const response = await fetch('/api/webscan/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    console.log('[INFO] Web scan started:', data.scan_id);
                    alert(`Tarama başlatıldı! Scan ID: ${data.scan_id}`);

                    // TODO: Start polling for results
                    // pollWebScanStatus(data.scan_id);
                } else {
                    throw new Error(data.error || 'Tarama başlatılamadı');
                }
            } catch (error) {
                console.error('[ERROR] Web scan start failed:', error);
                alert(`Hata: ${error.message}`);
            } finally {
                // Re-enable button
                startButton.disabled = false;
                startButton.textContent = 'Taramayı Başlat';
            }
        });
    }
});
