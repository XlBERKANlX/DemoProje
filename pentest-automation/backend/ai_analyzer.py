import google.generativeai as genai
import os
import json
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

class AIAnalyzer:
    def __init__(self):
        self.api_key = os.getenv('GEMINI_API_KEY')
        self.model_name = os.getenv('GEMINI_MODEL', 'gemini-1.5-flash')
        
        if not self.api_key:
            print("[ERROR] Gemini API Key not found in environment variables")
            return
            
        genai.configure(api_key=self.api_key)
        self.model = genai.GenerativeModel(self.model_name)
        print(f"[INFO] AI Analyzer initialized with model: {self.model_name}")

    def analyze_device(self, device_data):
        """
        Analyze device scan results using Gemini AI
        """
        if not self.api_key:
            return {"error": "API Key not configured"}

        # Prepare prompt
        prompt = self._build_device_analysis_prompt(device_data)
        
        try:
            # Generate response
            response = self.model.generate_content(prompt)
            
            # Parse JSON from response
            result = self._parse_json_response(response.text)
            return result
        except Exception as e:
            print(f"[ERROR] AI Analysis failed: {e}")
            return {"error": str(e)}

    def _build_device_analysis_prompt(self, device):
        """Build prompt for device analysis"""
        
        # Format ports and services
        ports_info = []
        if 'ports' in device:
            for p in device['ports']:
                service = p.get('service', 'unknown')
                version = p.get('version', '')
                port_str = f"Port: {p['port']}/{p['protocol']}, Service: {service}"
                if version:
                    port_str += f", Version: {version}"
                ports_info.append(port_str)
        
        ports_text = "\n".join(ports_info) if ports_info else "No open ports found"
        
        prompt = f"""
        Analyze the following network device scan results for security vulnerabilities.
        
        Target IP: {device.get('ip')}
        Hostname: {device.get('hostname')}
        OS: {device.get('os', 'Unknown')}
        Device Type: {device.get('device_type', 'Unknown')}
        
        Open Ports and Services:
        {ports_text}
        
        Please provide a security analysis in JSON format with the following structure:
        {{
            "summary": "Brief executive summary of the device's security posture",
            "risk_score": 0.0-10.0 (The highest CVSS score among identified vulnerabilities),
            "risk_level": "Low/Medium/High/Critical",
            "vulnerabilities": [
                {{
                    "title": "Vulnerability Name (e.g. CVE-2021-41773)",
                    "severity": "Low/Medium/High/Critical",
                    "cvss_score": 0.0-10.0 (Standard CVSS v3.1 score),
                    "description": "Brief description",
                    "affected_port": port_number
                }}
            ],
            "recommendations": [
                "Specific actionable recommendation 1",
                "Recommendation 2"
            ]
        }}
        
        IMPORTANT:
        1. Identify specific CVEs for the service versions provided.
        2. For each CVE, provide the standard CVSS v3.1 Base Score (e.g., 9.8, 7.5).
        3. Set the global 'risk_score' to the HIGHEST CVSS score found.
        4. If no specific CVEs are found but configuration is weak, estimate a risk score based on best practices (0-10).
        5. Return ONLY the JSON.
        """
        return prompt

    def _parse_json_response(self, text):
        """Clean and parse JSON response"""
        try:
            # Remove marquee formatting if present
            clean_text = text.replace('```json', '').replace('```', '').strip()
            return json.loads(clean_text)
        except json.JSONDecodeError:
            # Fallback for simple text response
            return {
                "summary": "Could not parse AI response as JSON",
                "risk_score": 0,
                "raw_response": text
            }

if __name__ == '__main__':
    # Test
    analyzer = AIAnalyzer()
    test_device = {
        'ip': '192.168.1.1',
        'ports': [
            {'port': 80, 'protocol': 'tcp', 'service': 'http', 'version': 'Apache 2.4.41'},
            {'port': 22, 'protocol': 'tcp', 'service': 'ssh', 'version': 'OpenSSH 7.2'}
        ]
    }
    print(analyzer.analyze_device(test_device))
