from flask import Flask, render_template, jsonify, request, send_from_directory
from flask_cors import CORS
import os
import threading
from scanner import NmapScanner

# Get absolute path to project root
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
FRONTEND_DIR = os.path.join(BASE_DIR, 'frontend')

app = Flask(__name__, 
            static_folder=FRONTEND_DIR,
            static_url_path='',
            template_folder=FRONTEND_DIR)
CORS(app)

# Initialize scanner
scanner = NmapScanner()

# Initialize AI Analyzer
from ai_analyzer import AIAnalyzer
ai_analyzer = AIAnalyzer()

# Initialize Web Scanner
from web_scanner import WebScanner
web_scanner = WebScanner()

# Store active scans
active_scans = {}
scan_counter = 0

def run_scan_async(scan_id, params):
    """Run scan in background thread"""
    global active_scans
    
    try:
        # Update status to running
        active_scans[scan_id]['status'] = 'running'
        
        # Execute scan with process tracking
        result = scanner.run_scan(params, scan_id, active_scans)
        
        # Check if cancelled
        if active_scans[scan_id].get('status') == 'cancelled':
            return
        
        if result['success']:
            active_scans[scan_id]['status'] = 'completed'
            active_scans[scan_id]['devices'] = result['devices']
            if 'warning' in result:
                active_scans[scan_id]['warning'] = result['warning']
        else:
            active_scans[scan_id]['status'] = 'failed'
            active_scans[scan_id]['error'] = result['error']
    
    except Exception as e:
        if active_scans[scan_id].get('status') != 'cancelled':
            active_scans[scan_id]['status'] = 'failed'
            active_scans[scan_id]['error'] = str(e)

@app.route('/')
def index():
    """Serve the main UI"""
    return render_template('index.html')

@app.route('/<path:filename>')
def serve_static(filename):
    """Serve static files (CSS, JS, images)"""
    return send_from_directory(FRONTEND_DIR, filename)

@app.route('/assets/<path:filename>')
def serve_assets(filename):
    """Serve asset files"""
    assets_dir = os.path.join(FRONTEND_DIR, 'assets')
    return send_from_directory(assets_dir, filename)

@app.route('/api/scan/check-nmap', methods=['GET'])
def check_nmap():
    """Check if Nmap is installed"""
    is_installed = scanner.check_nmap_installed()
    return jsonify({
        'installed': is_installed,
        'path': scanner.nmap_path,
        'platform': scanner.platform
    })

@app.route('/api/scan/start', methods=['POST'])
def start_scan():
    """Start a new scan with provided parameters"""
    global scan_counter
    
    try:
        # Check if Nmap is installed
        if not scanner.check_nmap_installed():
            return jsonify({
                'success': False,
                'error': 'Nmap kurulu deƒüil veya eri≈üilemiyor. L√ºtfen Nmap\'i kurun.'
            }), 400
        
        scan_params = request.json
        
        # Validate targets
        if not scan_params.get('targets'):
            return jsonify({
                'success': False,
                'error': 'Tarama hedefi belirtilmedi'
            }), 400
        
        # Create scan entry
        scan_counter += 1
        scan_id = scan_counter
        
        active_scans[scan_id] = {
            'status': 'starting',
            'params': scan_params,
            'devices': [],
            'error': None
        }
        
        # Start scan in background thread
        scan_thread = threading.Thread(
            target=run_scan_async,
            args=(scan_id, scan_params)
        )
        scan_thread.daemon = True
        scan_thread.start()
        
        return jsonify({
            'success': True,
            'scan_id': scan_id,
            'message': 'Tarama ba≈ülatƒ±ldƒ±'
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/scan/status/<int:scan_id>', methods=['GET'])
def get_scan_status(scan_id):
    """Get status of a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices_found': len(scan.get('devices', [])),
        'error': scan.get('error')
    })

@app.route('/api/scan/results/<int:scan_id>', methods=['GET'])
def get_scan_results(scan_id):
    """Get results for a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices': scan.get('devices', []),
        'error': scan.get('error'),
        'warning': scan.get('warning')
    })

@app.route('/api/scan/cancel/<int:scan_id>', methods=['POST'])
def cancel_scan(scan_id):
    """Cancel a running scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    if scan['status'] not in ['running', 'starting']:
        return jsonify({
            'success': False,
            'error': 'Tarama zaten tamamlanmƒ±≈ü veya iptal edilmi≈ü'
        }), 400
    
    try:
        # Mark as cancelled
        active_scans[scan_id]['status'] = 'cancelled'
        
        # Terminate process if exists
        if 'process' in scan and scan['process']:
            scan['process'].terminate()
            try:
                scan['process'].wait(timeout=5)
            except:
                scan['process'].kill()
        
        return jsonify({
            'success': True,
            'message': 'Tarama iptal edildi'
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'ƒ∞ptal hatasƒ±: {str(e)}'
        }), 500

import json

@app.route('/api/scan/analyze/<scan_id>', methods=['POST'])
def trigger_ai_analysis(scan_id):
    """Trigger AI analysis for an existing scan (Network or Web)"""
    try:
        scan = None
        
        # 1. Try finding in Network Scans (Integer IDs)
        if str(scan_id).isdigit():
            scan_id_int = int(scan_id)
            if scan_id_int in active_scans:
                scan = active_scans[scan_id_int]
                
        # 2. Try finding in Web Scans (String UUIDs) via WebScanner instance
        if not scan and 'web_scanner' in globals():
            if scan_id in web_scanner.active_scans:
                scan = web_scanner.active_scans[scan_id]

        if not scan:
            return jsonify({'success': False, 'error': 'Scan not found'}), 404
            
        # Check if scan is completed
        # Web scans use 'completed', Network scans use 'completed'
        if scan['status'] not in ['completed', 'stopped', 'error']: 
             return jsonify({'success': False, 'error': 'Scan must be completed first'}), 400

        print(f"[INFO] Manual AI Query triggered for Scan {scan_id}")

        # Import Analyzer
        from ai_analyzer import AIAnalyzer
        analyzer = AIAnalyzer()

        # Check Scan Type based on data presence
        if 'devices' in scan:
            # --- NETWORK SCAN ANALYSIS (Deep Batch Mode) ---
            devices = scan.get('devices', [])
            if not devices:
                 return jsonify({'success': False, 'error': 'No devices found to analyze'}), 400
            
            print(f"[INFO] Starting Deep Analysis for {len(devices)} devices...")
            
            aggregated_results = {
                "risk_score": 0,
                "risk_level": "Low",
                "summary": "",
                "vulnerabilities": [],
                "recommendations": []
            }
            
            total_risk = 0
            analyzed_count = 0
            
            for d in devices:
                # Prepare device data for analysis
                # Ensure all fields expected by analyze_device are present
                device_data = {
                    "ip": d.get('ip'),
                    "os": d.get('os'),
                    "ports": d.get('ports', []),
                    "hostname": d.get('hostname')
                }
                
                try:
                    # Perform deep analysis for this device
                    # analyze_device handles prompt building, batching, etc.
                    print(f"[INFO] Analyzing device: {device_data['ip']}")
                    device_analysis = analyzer.analyze_device(device_data)
                    
                    if 'error' not in device_analysis:
                        # Aggregate Results
                        
                        # Add Device Prefix to Vulnerabilities
                        for vuln in device_analysis.get('vulnerabilities', []):
                            vuln['title'] = f"[{device_data['ip']}] {vuln.get('title', 'Unknown Vuln')}"
                            aggregated_results['vulnerabilities'].append(vuln)
                            
                        # Merge Recommendations (unique)
                        for rec in device_analysis.get('recommendations', []):
                            if rec not in aggregated_results['recommendations']:
                                aggregated_results['recommendations'].append(rec)
                                
                        # Sum Risk
                        total_risk += float(device_analysis.get('risk_score', 0))
                        analyzed_count += 1
                        
                except Exception as e:
                    print(f"[ERROR] Failed to analyze device {device_data['ip']}: {e}")
                    continue
            
            # Finalize Aggregation
            if analyzed_count > 0:
                avg_risk = total_risk / analyzed_count
                aggregated_results['risk_score'] = round(avg_risk, 1)
                
                # Determine Risk Level
                if avg_risk >= 9.0: aggregated_results['risk_level'] = "CRITICAL"
                elif avg_risk >= 7.0: aggregated_results['risk_level'] = "HIGH"
                elif avg_risk >= 4.0: aggregated_results['risk_level'] = "MEDIUM"
                else: aggregated_results['risk_level'] = "LOW"
                
                aggregated_results['summary'] = (
                    f"Aƒü genelinde {analyzed_count} cihaz analiz edildi. "
                    f"Toplam {len(aggregated_results['vulnerabilities'])} zafiyet tespit edildi. "
                    f"Genel risk seviyesi: {aggregated_results['risk_level']} ({aggregated_results['risk_score']}/10)."
                )
            else:
                aggregated_results['summary'] = "Analiz tamamlandƒ± ancak hi√ßbir cihazdan ge√ßerli sonu√ß alƒ±namadƒ±."

            ai_results = aggregated_results
            
        else:
            # --- WEB SCAN ANALYSIS ---
            raw_nikto = scan.get('nikto', {}).get('output', [])
            nikto_lines = []
            for item in raw_nikto:
                if isinstance(item, dict):
                    nikto_lines.append(item.get('message', ''))
                else:
                    nikto_lines.append(str(item))
            nikto_output = "\n".join(nikto_lines)

            gobuster_output = scan.get('gobuster', {}).get('results', [])
            parsed_data = analyzer.parse_web_scan_results(nikto_output, gobuster_output)
            ai_results = analyzer.analyze_web_scan(parsed_data)

        # Update State
        scan['ai_analysis'] = ai_results
        
        return jsonify({
            'success': True,
            'ai_analysis': ai_results
        })

    except Exception as e:
        print(f"[ERROR] Manual AI trigger failed: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/analyze/device', methods=['POST'])
def analyze_device_security():
    """Analyze device security using Gemini AI"""
    try:
        device_data = request.json
        
        if not device_data:
            return jsonify({
                'success': False,
                'error': 'No device data provided'
            }), 400
            
        print(f"[INFO] Analyzing device: {device_data.get('ip')}")
        
        # Call AI Analyzer
        analysis_result = ai_analyzer.analyze_device(device_data)
        
        if 'error' in analysis_result:
            return jsonify({
                'success': False,
                'error': analysis_result['error']
            }), 500
            
        return jsonify({
            'success': True,
            'analysis': analysis_result
        })
        
    except Exception as e:
        print(f"[ERROR] Analysis endpoint error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# ===== WEB SCAN ENDPOINTS =====

@app.route('/api/webscan/start', methods=['POST'])
def start_web_scan():
    """Start a new web scan (Gobuster + Nikto)"""
    try:
        params = request.json
        
        # Validate target URL
        if not params.get('target_url'):
            return jsonify({
                'success': False,
                'error': 'Hedef URL belirtilmedi'
            }), 400
        
        # Validate at least one scanner is enabled
        gobuster_enabled = params.get('gobuster', {}).get('enabled', False)
        nikto_enabled = params.get('nikto', {}).get('enabled', False)
        
        if not gobuster_enabled and not nikto_enabled:
            return jsonify({
                'success': False,
                'error': 'En az bir tarama t√ºr√º se√ßilmeli (Gobuster veya Nikto)'
            }), 400
        
        # Wordlist is required for Gobuster
        if gobuster_enabled and not params.get('wordlist'):
            return jsonify({
                'success': False,
                'error': 'Gobuster i√ßin wordlist girmeniz gereklidir!'
            }), 400
        
        # Debug: Log recursive parameters
        print(f"[DEBUG] Recursive: {params.get('recursive', False)}")
        print(f"[DEBUG] Recursive Mode: {params.get('recursive_mode', 'base')}")
        print(f"[DEBUG] Gobuster enabled: {gobuster_enabled}, Nikto enabled: {nikto_enabled}")
        
        # Create scan
        scan_id = web_scanner.create_scan(params)
        
        return jsonify({
            'success': True,
            'scan_id': scan_id,
            'message': 'Web taramasƒ± ba≈ülatƒ±ldƒ±'
        })
        
    except Exception as e:
        print(f"[ERROR] Web scan start error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/webscan/status/<scan_id>', methods=['GET'])
def get_web_scan_status(scan_id):
    """Get status of a web scan"""
    try:
        scan_state = web_scanner.get_scan_status(scan_id)
        
        if not scan_state:
            return jsonify({
                'success': False,
                'error': 'Tarama bulunamadƒ±'
            }), 404
        
        return jsonify({
            'success': True,
            'scan_id': scan_id,
            'status': scan_state['status'],
            'gobuster': {
                'enabled': scan_state['gobuster']['enabled'],
                'status': scan_state['gobuster']['status'],
                'results_count': len(scan_state['gobuster']['results']),
                'results': scan_state['gobuster']['results'],
                'error': scan_state['gobuster']['error']
            },
            'nikto': {
                'enabled': scan_state['nikto']['enabled'],
                'status': scan_state['nikto']['status'],
                'output_count': len(scan_state['nikto']['output']),
                'output': scan_state['nikto']['output'],
                'error': scan_state['nikto']['error']
            }
        })
        
    except Exception as e:
        print(f"[ERROR] Web scan status error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/webscan/cancel/<scan_id>', methods=['POST'])
def cancel_web_scan(scan_id):
    """Cancel a running web scan"""
    try:
        success = web_scanner.cancel_scan(scan_id)
        
        if not success:
            return jsonify({
                'success': False,
                'error': 'Tarama iptal edilemedi (bulunamadƒ± veya zaten tamamlanmƒ±≈ü)'
            }), 400
        
        return jsonify({
            'success': True,
            'message': 'Web taramasƒ± iptal edildi'
        })
        
    except Exception as e:
        print(f"[ERROR] Web scan cancel error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

if __name__ == '__main__':
    print("üõ°Ô∏è  Pentest Otomasyon Motoru ba≈ülatƒ±lƒ±yor...")
    print("üì° Server: http://localhost:5000")
    
    # Check Nmap on startup
    if scanner.check_nmap_installed():
        print(f"‚úÖ Nmap kurulu: {scanner.nmap_path}")
    else:
        print("‚ö†Ô∏è  UYARI: Nmap bulunamadƒ±! Tarama yapƒ±lamayacak.")
    
    app.run(debug=True, host='0.0.0.0', port=5000)
