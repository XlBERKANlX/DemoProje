from flask import Flask, render_template, jsonify, request
from flask_cors import CORS
import os
import threading
from scanner import NmapScanner

app = Flask(__name__, 
            static_folder='../frontend',
            template_folder='../frontend')
CORS(app)

# Initialize scanner
scanner = NmapScanner()

# Store active scans
active_scans = {}
scan_counter = 0

def run_scan_async(scan_id, params):
    """Run scan in background thread"""
    global active_scans
    
    try:
        # Update status to running
        active_scans[scan_id]['status'] = 'running'
        
        # Execute scan
        result = scanner.run_scan(params)
        
        if result['success']:
            active_scans[scan_id]['status'] = 'completed'
            active_scans[scan_id]['devices'] = result['devices']
        else:
            active_scans[scan_id]['status'] = 'failed'
            active_scans[scan_id]['error'] = result['error']
    
    except Exception as e:
        active_scans[scan_id]['status'] = 'failed'
        active_scans[scan_id]['error'] = str(e)

@app.route('/')
def index():
    """Serve the main UI"""
    return render_template('index.html')

@app.route('/api/scan/check-nmap', methods=['GET'])
def check_nmap():
    """Check if Nmap is installed"""
    is_installed = scanner.check_nmap_installed()
    return jsonify({
        'installed': is_installed,
        'path': scanner.nmap_path,
        'platform': scanner.platform
    })

@app.route('/api/scan/start', methods=['POST'])
def start_scan():
    """Start a new scan with provided parameters"""
    global scan_counter
    
    try:
        # Check if Nmap is installed
        if not scanner.check_nmap_installed():
            return jsonify({
                'success': False,
                'error': 'Nmap kurulu deƒüil veya eri≈üilemiyor. L√ºtfen Nmap\'i kurun.'
            }), 400
        
        scan_params = request.json
        
        # Validate targets
        if not scan_params.get('targets'):
            return jsonify({
                'success': False,
                'error': 'Tarama hedefi belirtilmedi'
            }), 400
        
        # Create scan entry
        scan_counter += 1
        scan_id = scan_counter
        
        active_scans[scan_id] = {
            'status': 'starting',
            'params': scan_params,
            'devices': [],
            'error': None
        }
        
        # Start scan in background thread
        scan_thread = threading.Thread(
            target=run_scan_async,
            args=(scan_id, scan_params)
        )
        scan_thread.daemon = True
        scan_thread.start()
        
        return jsonify({
            'success': True,
            'scan_id': scan_id,
            'message': 'Tarama ba≈ülatƒ±ldƒ±'
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/scan/status/<int:scan_id>', methods=['GET'])
def get_scan_status(scan_id):
    """Get status of a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices_found': len(scan.get('devices', [])),
        'error': scan.get('error')
    })

@app.route('/api/scan/results/<int:scan_id>', methods=['GET'])
def get_scan_results(scan_id):
    """Get results for a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices': scan.get('devices', []),
        'error': scan.get('error')
    })

@app.route('/api/analyze/vulnerability', methods=['POST'])
def analyze_vulnerability():
    """Analyze vulnerability using Gemini AI"""
    try:
        data = request.json
        service = data.get('service')
        version = data.get('version')
        port = data.get('port')
        
        # TODO: Implement Gemini API integration
        # For now, return placeholder data
        
        return jsonify({
            'success': True,
            'analysis': {
                'cves': [
                    {
                        'id': 'CVE-2019-0211',
                        'severity': 'critical',
                        'score': 9.8,
                        'type': 'Yetki Y√ºkseltme',
                        'description': 'Apache 2.4.29 s√ºr√ºm√º yetki y√ºkseltme (PrivExec) a√ßƒ±ƒüƒ± barƒ±ndƒ±rƒ±yor.',
                        'recommendations': [
                            '1.Apache\'yi 2.4.50+ s√ºr√ºm√ºne y√ºkseltin.',
                            '2.Su config ayarlarƒ±nƒ± kontrol edin...'
                        ]
                    }
                ]
            }
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

if __name__ == '__main__':
    print("üõ°Ô∏è  Pentest Otomasyon Motoru ba≈ülatƒ±lƒ±yor...")
    print("üì° Server: http://localhost:5000")
    
    # Check Nmap on startup
    if scanner.check_nmap_installed():
        print(f"‚úÖ Nmap kurulu: {scanner.nmap_path}")
    else:
        print("‚ö†Ô∏è  UYARI: Nmap bulunamadƒ±! Tarama yapƒ±lamayacak.")
    
    app.run(debug=True, host='0.0.0.0', port=5000)
