from flask import Flask, render_template, jsonify, request, send_from_directory
from flask_cors import CORS
import os
import threading
from scanner import NmapScanner

# Get absolute path to project root
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
FRONTEND_DIR = os.path.join(BASE_DIR, 'frontend')

app = Flask(__name__, 
            static_folder=FRONTEND_DIR,
            static_url_path='',
            template_folder=FRONTEND_DIR)
CORS(app)

# Initialize scanner
scanner = NmapScanner()

# Initialize AI Analyzer
from ai_analyzer import AIAnalyzer
ai_analyzer = AIAnalyzer()

# Store active scans
active_scans = {}
scan_counter = 0

def run_scan_async(scan_id, params):
    """Run scan in background thread"""
    global active_scans
    
    try:
        # Update status to running
        active_scans[scan_id]['status'] = 'running'
        
        # Execute scan with process tracking
        result = scanner.run_scan(params, scan_id, active_scans)
        
        # Check if cancelled
        if active_scans[scan_id].get('status') == 'cancelled':
            return
        
        if result['success']:
            active_scans[scan_id]['status'] = 'completed'
            active_scans[scan_id]['devices'] = result['devices']
            if 'warning' in result:
                active_scans[scan_id]['warning'] = result['warning']
        else:
            active_scans[scan_id]['status'] = 'failed'
            active_scans[scan_id]['error'] = result['error']
    
    except Exception as e:
        if active_scans[scan_id].get('status') != 'cancelled':
            active_scans[scan_id]['status'] = 'failed'
            active_scans[scan_id]['error'] = str(e)

@app.route('/')
def index():
    """Serve the main UI"""
    return render_template('index.html')

@app.route('/<path:filename>')
def serve_static(filename):
    """Serve static files (CSS, JS, images)"""
    return send_from_directory(FRONTEND_DIR, filename)

@app.route('/assets/<path:filename>')
def serve_assets(filename):
    """Serve asset files"""
    assets_dir = os.path.join(FRONTEND_DIR, 'assets')
    return send_from_directory(assets_dir, filename)

@app.route('/api/scan/check-nmap', methods=['GET'])
def check_nmap():
    """Check if Nmap is installed"""
    is_installed = scanner.check_nmap_installed()
    return jsonify({
        'installed': is_installed,
        'path': scanner.nmap_path,
        'platform': scanner.platform
    })

@app.route('/api/scan/start', methods=['POST'])
def start_scan():
    """Start a new scan with provided parameters"""
    global scan_counter
    
    try:
        # Check if Nmap is installed
        if not scanner.check_nmap_installed():
            return jsonify({
                'success': False,
                'error': 'Nmap kurulu deƒüil veya eri≈üilemiyor. L√ºtfen Nmap\'i kurun.'
            }), 400
        
        scan_params = request.json
        
        # Validate targets
        if not scan_params.get('targets'):
            return jsonify({
                'success': False,
                'error': 'Tarama hedefi belirtilmedi'
            }), 400
        
        # Create scan entry
        scan_counter += 1
        scan_id = scan_counter
        
        active_scans[scan_id] = {
            'status': 'starting',
            'params': scan_params,
            'devices': [],
            'error': None
        }
        
        # Start scan in background thread
        scan_thread = threading.Thread(
            target=run_scan_async,
            args=(scan_id, scan_params)
        )
        scan_thread.daemon = True
        scan_thread.start()
        
        return jsonify({
            'success': True,
            'scan_id': scan_id,
            'message': 'Tarama ba≈ülatƒ±ldƒ±'
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/scan/status/<int:scan_id>', methods=['GET'])
def get_scan_status(scan_id):
    """Get status of a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices_found': len(scan.get('devices', [])),
        'error': scan.get('error')
    })

@app.route('/api/scan/results/<int:scan_id>', methods=['GET'])
def get_scan_results(scan_id):
    """Get results for a specific scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    return jsonify({
        'success': True,
        'scan_id': scan_id,
        'status': scan['status'],
        'devices': scan.get('devices', []),
        'error': scan.get('error'),
        'warning': scan.get('warning')
    })

@app.route('/api/scan/cancel/<int:scan_id>', methods=['POST'])
def cancel_scan(scan_id):
    """Cancel a running scan"""
    if scan_id not in active_scans:
        return jsonify({
            'success': False,
            'error': 'Tarama bulunamadƒ±'
        }), 404
    
    scan = active_scans[scan_id]
    
    if scan['status'] not in ['running', 'starting']:
        return jsonify({
            'success': False,
            'error': 'Tarama zaten tamamlanmƒ±≈ü veya iptal edilmi≈ü'
        }), 400
    
    try:
        # Mark as cancelled
        active_scans[scan_id]['status'] = 'cancelled'
        
        # Terminate process if exists
        if 'process' in scan and scan['process']:
            scan['process'].terminate()
            try:
                scan['process'].wait(timeout=5)
            except:
                scan['process'].kill()
        
        return jsonify({
            'success': True,
            'message': 'Tarama iptal edildi'
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'ƒ∞ptal hatasƒ±: {str(e)}'
        }), 500

@app.route('/api/analyze/device', methods=['POST'])
def analyze_device_security():
    """Analyze device security using Gemini AI"""
    try:
        device_data = request.json
        
        if not device_data:
            return jsonify({
                'success': False,
                'error': 'No device data provided'
            }), 400
            
        print(f"[INFO] Analyzing device: {device_data.get('ip')}")
        
        # Call AI Analyzer
        analysis_result = ai_analyzer.analyze_device(device_data)
        
        if 'error' in analysis_result:
            return jsonify({
                'success': False,
                'error': analysis_result['error']
            }), 500
            
        return jsonify({
            'success': True,
            'analysis': analysis_result
        })
        
    except Exception as e:
        print(f"[ERROR] Analysis endpoint error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

if __name__ == '__main__':
    print("üõ°Ô∏è  Pentest Otomasyon Motoru ba≈ülatƒ±lƒ±yor...")
    print("üì° Server: http://localhost:5000")
    
    # Check Nmap on startup
    if scanner.check_nmap_installed():
        print(f"‚úÖ Nmap kurulu: {scanner.nmap_path}")
    else:
        print("‚ö†Ô∏è  UYARI: Nmap bulunamadƒ±! Tarama yapƒ±lamayacak.")
    
    app.run(debug=True, host='0.0.0.0', port=5000)
